# 业务参数配置规范

## 1. 概述

业务参数配置用于管理系统中的可配置参数，支持动态修改而无需重启应用。参数配置存储在数据库 `sys_config` 表中，并通过缓存机制提高访问性能。

## 2. 参数配置表结构

### 2.1 表结构

```sql
CREATE TABLE sys_config (
  config_id         INT(5)          NOT NULL AUTO_INCREMENT    COMMENT '参数主键',
  config_name       VARCHAR(100)    DEFAULT ''                 COMMENT '参数名称',
  config_key        VARCHAR(100)    DEFAULT ''                 COMMENT '参数键名',
  config_value      VARCHAR(500)    DEFAULT ''                 COMMENT '参数键值',
  config_type       CHAR(1)         DEFAULT 'N'                COMMENT '系统内置（Y是 N否）',
  create_by         VARCHAR(64)     DEFAULT ''                 COMMENT '创建者',
  create_time       DATETIME                                   COMMENT '创建时间',
  update_by         VARCHAR(64)     DEFAULT ''                 COMMENT '更新者',
  update_time       DATETIME                                   COMMENT '更新时间',
  remark            VARCHAR(500)    DEFAULT NULL               COMMENT '备注',
  PRIMARY KEY (config_id)
) ENGINE=INNODB AUTO_INCREMENT=100 COMMENT = '参数配置表';
```

### 2.2 字段说明

| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| config_id | INT | 参数主键，自增 | 是 |
| config_name | VARCHAR(100) | 参数名称，用于展示 | 是 |
| config_key | VARCHAR(100) | 参数键名，唯一标识 | 是 |
| config_value | VARCHAR(500) | 参数键值 | 是 |
| config_type | CHAR(1) | 系统内置标识，Y=是，N=否 | 是 |
| remark | VARCHAR(500) | 备注说明 | 否 |

## 3. 参数键名命名规范

### 3.1 命名规则

参数键名采用**点分隔的层级命名**方式，格式：`模块.功能.参数名`

```
{模块}.{功能}.{参数名}
```

### 3.2 命名示例

```java
// ✅ 正确示例
sys.user.initPassword          // 系统-用户-初始密码
sys.index.skinName             // 系统-首页-皮肤名称
sys.account.captchaEnabled     // 系统-账号-验证码开关
sys.upload.maxFileSize         // 系统-上传-最大文件大小

// ❌ 错误示例
userInitPassword               // 缺少模块前缀
sys_user_init_password         // 使用下划线而非点分隔
initPassword                   // 缺少模块和功能前缀
```

### 3.3 模块划分

| 模块前缀 | 说明 | 示例 |
|---------|------|------|
| `sys` | 系统级配置 | `sys.user.initPassword` |
| `app` | 应用级配置 | `app.name` |
| `business` | 业务级配置 | `business.order.timeout` |
| `third` | 第三方配置 | `third.alipay.appId` |

## 4. 参数配置使用

### 4.1 Service 层使用

```java
@Service
public class UserServiceImpl implements IUserService
{
    @Autowired
    private ISysConfigService configService;
    
    /**
     * 获取用户初始密码
     */
    public String getInitPassword()
    {
        return configService.selectConfigByKey("sys.user.initPassword");
    }
    
    /**
     * 检查验证码是否启用
     */
    public boolean isCaptchaEnabled()
    {
        return configService.selectCaptchaEnabled();
    }
}
```

### 4.2 Controller 层使用

```java
@RestController
@RequestMapping("/system/user")
public class SysUserController
{
    @Autowired
    private ISysConfigService configService;
    
    @PostMapping("/register")
    public AjaxResult register(@RequestBody RegisterBody user)
    {
        // 检查验证码开关
        if (configService.selectCaptchaEnabled())
        {
            // 验证码校验逻辑
            validateCaptcha(user.getCode(), user.getUuid());
        }
        
        // 注册逻辑
        return registerService.register(user);
    }
}
```

### 4.3 配置类中使用

```java
@Configuration
public class UploadConfig
{
    @Autowired
    private ISysConfigService configService;
    
    @PostConstruct
    public void init()
    {
        // 从配置表读取上传配置
        String maxFileSize = configService.selectConfigByKey("sys.upload.maxFileSize");
        // 设置上传配置
    }
}
```

## 5. 参数配置管理

### 5.1 新增参数配置

#### 5.1.1 通过管理界面

1. 访问：系统管理 → 参数设置
2. 点击"新增"按钮
3. 填写参数信息：
   - **参数名称**：用于展示的名称
   - **参数键名**：遵循命名规范
   - **参数键值**：参数的实际值
   - **系统内置**：Y=系统内置（不可删除），N=用户自定义
   - **备注**：参数说明和使用场景

#### 5.1.2 通过 SQL 脚本

```sql
INSERT INTO sys_config 
(config_name, config_key, config_value, config_type, create_by, create_time, remark)
VALUES 
('用户管理-账号初始密码', 'sys.user.initPassword', '123456', 'Y', 'admin', NOW(), '初始化密码 123456');
```

### 5.2 修改参数配置

```java
// 通过 Service 修改
SysConfig config = new SysConfig();
config.setConfigId(1L);
config.setConfigValue("newPassword");
configService.updateConfig(config);

// 修改后需要刷新缓存
configService.resetConfigCache();
```

### 5.3 查询参数配置

```java
// 根据键名查询
String value = configService.selectConfigByKey("sys.user.initPassword");

// 查询参数列表
SysConfig query = new SysConfig();
query.setConfigName("用户");
List<SysConfig> list = configService.selectConfigList(query);
```

## 6. 缓存机制

### 6.1 缓存说明

参数配置使用 Redis 缓存，提高访问性能：

- **缓存键格式**：`sys_config:{configKey}`
- **缓存更新**：修改配置后自动更新缓存
- **缓存清理**：支持手动清理和重置缓存

### 6.2 缓存操作

```java
// 加载参数缓存
configService.loadingConfigCache();

// 清空参数缓存
configService.clearConfigCache();

// 重置参数缓存
configService.resetConfigCache();
```

### 6.3 缓存刷新时机

- 新增参数配置后
- 修改参数配置后
- 删除参数配置后
- 系统启动时自动加载

## 7. 参数类型规范

### 7.1 字符串类型

```java
// 配置值：字符串
config_key: "sys.app.name"
config_value: "若依管理系统"
```

### 7.2 数值类型

```java
// 配置值：数字（存储为字符串）
config_key: "sys.upload.maxFileSize"
config_value: "10485760"  // 10MB，单位：字节
```

### 7.3 布尔类型

```java
// 配置值：true/false（存储为字符串）
config_key: "sys.account.captchaEnabled"
config_value: "true"
```

### 7.4 JSON 类型

```java
// 配置值：JSON 字符串
config_key: "sys.third.alipay.config"
config_value: "{\"appId\":\"xxx\",\"appKey\":\"xxx\"}"
```

## 8. 系统内置参数

### 8.1 内置参数说明

系统内置参数（`config_type = 'Y'`）是系统运行必需的参数，不应随意删除或修改。

### 8.2 常见内置参数

| 参数键名 | 参数名称 | 默认值 | 说明 |
|---------|---------|--------|------|
| `sys.index.skinName` | 主框架页-默认皮肤样式名称 | `skin-blue` | 系统主题皮肤 |
| `sys.user.initPassword` | 用户管理-账号初始密码 | `123456` | 新用户默认密码 |
| `sys.account.captchaEnabled` | 账号自助-验证码开关 | `true` | 是否启用验证码 |

## 9. 最佳实践

### 9.1 参数设计原则

1. **唯一性**：参数键名必须唯一
2. **可读性**：参数名称应清晰表达用途
3. **分类管理**：按模块和功能分类
4. **文档化**：备注字段应详细说明参数用途

### 9.2 使用建议

1. **频繁访问的参数**：使用缓存机制
2. **敏感信息**：考虑加密存储
3. **配置验证**：修改配置时进行有效性验证
4. **版本管理**：重要配置变更应记录版本

### 9.3 注意事项

- ⚠️ 系统内置参数（`config_type='Y'`）不应删除
- ⚠️ 修改配置后需要刷新缓存
- ⚠️ 参数键名一旦确定，不应随意修改
- ⚠️ 参数值长度限制为 500 字符，超长内容考虑使用其他存储方式

## 10. 示例代码

### 10.1 完整示例

```java
@Service
public class OrderServiceImpl implements IOrderService
{
    @Autowired
    private ISysConfigService configService;
    
    private static final String ORDER_TIMEOUT_KEY = "business.order.timeout";
    private static final String ORDER_MAX_AMOUNT_KEY = "business.order.maxAmount";
    
    /**
     * 创建订单
     */
    public AjaxResult createOrder(Order order)
    {
        // 获取订单超时时间（分钟）
        String timeoutStr = configService.selectConfigByKey(ORDER_TIMEOUT_KEY);
        int timeout = Integer.parseInt(timeoutStr != null ? timeoutStr : "30");
        
        // 获取订单最大金额
        String maxAmountStr = configService.selectConfigByKey(ORDER_MAX_AMOUNT_KEY);
        BigDecimal maxAmount = new BigDecimal(maxAmountStr != null ? maxAmountStr : "10000");
        
        // 验证订单金额
        if (order.getAmount().compareTo(maxAmount) > 0)
        {
            return AjaxResult.error("订单金额超过最大限制：" + maxAmount);
        }
        
        // 设置订单超时时间
        order.setExpireTime(LocalDateTime.now().plusMinutes(timeout));
        
        // 创建订单逻辑
        return orderMapper.insertOrder(order);
    }
}
```

## 11. 常见问题

### 11.1 参数未生效

**问题**：修改参数后未生效

**解决**：
1. 检查缓存是否已刷新：`configService.resetConfigCache()`
2. 确认参数键名是否正确
3. 检查是否有多个同名参数

### 11.2 参数值类型转换

**问题**：从配置获取的值是字符串，需要转换为其他类型

**解决**：
```java
// 转换为整数
int timeout = Integer.parseInt(configService.selectConfigByKey("business.order.timeout"));

// 转换为布尔值
boolean enabled = Boolean.parseBoolean(configService.selectConfigByKey("sys.account.captchaEnabled"));

// 转换为 BigDecimal
BigDecimal amount = new BigDecimal(configService.selectConfigByKey("business.order.maxAmount"));
```

### 11.3 参数默认值

**问题**：配置不存在时如何处理

**解决**：
```java
String value = configService.selectConfigByKey("sys.user.initPassword");
if (StringUtils.isEmpty(value))
{
    value = "123456"; // 使用默认值
}
```

